<?php require_once __DIR__.'/../config/db.php'; if(session_status()===PHP_SESSION_NONE) session_start(); if($_SERVER['REQUEST_METHOD']!=='POST') header('Location:/user/dashboard.php'); $exam_id=intval($_POST['exam_id']); $stmt=$pdo->prepare('SELECT id FROM questions WHERE exam_id=?'); $stmt->execute([$exam_id]); $qs=$stmt->fetchAll(PDO::FETCH_ASSOC); $total=count($qs); $score=0; $answers=[]; foreach($qs as $q){ $qid=$q['id']; $sel=isset($_POST['q_'.$qid])?intval($_POST['q_'.$qid]):-1; $correct = isset($_POST['correct_'.$qid])?intval($_POST['correct_'.$qid]):null; if($correct!==null && $sel===$correct) $score++; $answers[]= ['question_id'=>$qid,'selected'=>$sel]; } $pdo->prepare('INSERT INTO attempts (user_id,exam_id,answers,score,total_questions,started_at,completed_at) VALUES (?,?,?,?,now(),now())')->execute([$_SESSION['user']['id'],$exam_id,json_encode($answers),$score,$total]); header('Location:/user/result.php?score='.$score.'&total='.$total); exit; ?>